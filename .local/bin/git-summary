#!/bin/bash

dir="$1"
is_verbose=true

flags='s'
while getopts "$flags" option "${@:2}"; do
    case "$option" in
        s) is_verbose=false ;;
        *) echo "Recognized flags: $flags"; exit ;;
    esac
done

# No directory has been provided, use current
if [[ -z "$dir" ]]; then
    dir="$(pwd)"
fi

readarray -t dirs < <(find "$dir" -maxdepth 3 -type d -name .git -not -path '*/site-packages/*' -not -path '*/node_modules/*')

message() {
    echo -en "\033[0;35m"
    echo "${@}"
    echo -en "\033[0m"
}

warning() {
    echo -en "\033[0;31m"
    echo "${@}"
    echo -en "\033[0m"
}

# Loop all sub-directories
for d in "${dirs[@]}"; do
    is_modified=false
    is_untracked=false
    is_ahead=false

    cd "$d/.." ||  exit

    # Check for modified files
    if git status | grep -q modified; then
        is_modified=true
    fi

    # Check for untracked files
    if git status | grep -q Untracked; then
        is_untracked=true
    fi

    # Check for unpushed changes
    if git status | grep -q 'Your branch is ahead'; then
        is_ahead=true
    fi

    if $is_modified || $is_untracked || $is_ahead || $is_verbose; then
        message "$d"
    fi

    $is_modified && warning "Modified files"
    $is_untracked && warning "Untracked files"
    $is_ahead && warning "Unpushed commit"
    ! $is_modified && ! $is_untracked && ! $is_ahead && $is_verbose &&
        echo "Nothing to commit."

    $is_verbose && echo
    cd - > /dev/null || exit
done
